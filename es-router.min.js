"use strict";function _toConsumableArray(t){if(Array.isArray(t)){for(var e=0,r=Array(t.length);e<t.length;e++)r[e]=t[e];return r}return Array.from(t)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function isNotDefined(t){return"undefined"==typeof t||null===t}function clone(t){return JSON.parse(JSON.stringify(t))}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol?"symbol":typeof t},_createClass=function(){function t(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,r,n){return r&&t(e.prototype,r),n&&t(e,n),e}}(),EsRouter=function(){function t(e){var r=this,n=e.useHash,i=e.routes,a=e.notStrictRouting,s=e.home,o=e.base;if(_classCallCheck(this,t),this.events={startRouteChange:[],finishRouteChange:[],paramChange:[]},this.useHash=n,this.routes=i,this.base=o,this.notStrictRouting=a,this.queryParams=this.getParamsFromUrl(),o&&"/"===o[o.length-1]&&(this.base=this.base.substring(0,this.base.length-1)),!o&&!n){var u=document.getElementsByTagName("base")[0]&&document.getElementsByTagName("base")[0].href||"";this.base=u.split(this.returnWindow().location.origin)[1]}this.allRoutes=Object.assign(i,{}).reduce(function(t,e){if(e.name===s&&(r.home=e),e.variablePath)throw new Error("route objects cannot be initialized with a key of variablePath");var n=e.route.split("/").filter(function(t){return t}),i=n.length,a=n.reduce(function(t,e,r){var n={id:e.split(":")[1],index:r};return e.includes(":")?[].concat(_toConsumableArray(t),[n]):[].concat(_toConsumableArray(t))},[]);return e.variablePath=a,t[i]=t[i]?[].concat(_toConsumableArray(t[i]),[e]):[e],t},{}),n?(-1===this.returnWindow().location.href.indexOf("#")&&(this.returnWindow().location.hash="/"),this.returnWindow().addEventListener("hashchange",function(t){return r.wasChangedByUser?(r.wasChangedByUser=!1,void 0):(r.eventChangeListener.call(r,t),void 0)})):this.returnWindow().onpopstate=this.eventChangeListener.bind(this),this.path(this.getPathFromUrl())}return _createClass(t,[{key:"returnWindow",value:function(){return window}},{key:"getState",value:function(){return this.currentPathObject}},{key:"getParamsFromUrl",value:function(){var t=this.useHash?this.returnWindow().location.hash.split("?")[1]:this.returnWindow().location.search.split("?")[1];return t&&t.split("&").reduce(function(t,e){var r=e.split("=");return t[decodeURIComponent(r[0])]=decodeURIComponent(r[1])||"",t},{})||{}}},{key:"getPathFromUrl",value:function(){return this.useHash?this.returnWindow().location.hash.split("?")[0].substring(1):this.returnWindow().location.pathname.split(this.base)[1]||"/"}},{key:"eventChangeListener",value:function(){var t=this,e=this.getParamsFromUrl(),r=this.getPathFromUrl(),n=this.createParamString(e).join(""),i=this.createParamString(this.queryParams).join("");if(n!==i&&(this.queryParams=this.getParamsFromUrl(),this.events.paramChange.forEach(function(e){e(t.queryParams)})),r!==this.currentPath){this.currentPath=r;var a=this.getPreDefinedRoute(this.currentPath),s=clone(this.currentPathObject);this.currentPathObject=a,this.startRouteChange(s,a),this.finishRouteChange(s,a)}}},{key:"subscribe",value:function(t,e){var r=this;if(!t||!e)return{};if(!this.events.hasOwnProperty.call(this.events,t)||"string"!=typeof t||"function"!=typeof e)return{};var n=this.events[t].push(e)-1;return{remove:function(){delete r.events[t][n]}}}},{key:"unsubscribe",value:function(t){var e=this,r=function(e){return e!==t};Object.keys(this.events).forEach(function(t){e.events[t]=e.events[t].filter(r)})}},{key:"search",value:function(t,e){var r=this;if(isNotDefined(t))return this.queryParams;"object"===("undefined"==typeof t?"undefined":_typeof(t))?this.queryParams=Object.assign(this.queryParams,t):isNotDefined(e)?this.queryParams[t]&&delete this.queryParams[t]:this.queryParams[t]=e,Object.keys(this.queryParams).forEach(function(t){r.queryParams[t]||"number"==typeof r.queryParams[t]||delete r.queryParams[t]});var n=this.getParamsFromUrl(),i=this.createParamString(n).join(""),a=this.createParamString(this.queryParams).join("");return i===a?void 0:(this.path(this.currentPath,!0),this.events.paramChange.forEach(function(t){t(r.queryParams)}),this.queryParams)}},{key:"getPreDefinedRoute",value:function(t){var e=t.split("/").filter(function(t){return t}),r=clone(this.allRoutes);return r[e.length]&&r[e.length].reduce(function(t,r){if(t)return t;var n=[].concat(_toConsumableArray(e)),i=r.route.split("/").filter(function(t){return t}),a=void 0;if(r.variablePath&&r.variablePath.length&&(a=r.variablePath.reduce(function(t,e,r){var a=n.splice(e.index-r,1)[0];return i.splice(e.index-r,1),t[e.id]=a,t},{})),n.join("")===i.join("")){var s=Object.assign({},r);return s.variablePath=a,s}return!1},0)}},{key:"createParamString",value:function(t){return Object.keys(t).reduce(function(e,r){var n=r.toString(),i=t[r].toString();return isNotDefined(i)||!i.length?e:[].concat(_toConsumableArray(e),[encodeURIComponent(n)+"="+encodeURIComponent(i)])},[])}},{key:"path",value:function(t,e){if(t){var r=t,n=this.getPreDefinedRoute(r);n||this.notStrictRouting||(r=this.home.route,n=this.home),e||this.startRouteChange(this.currentPathObject,n);var i=this.createParamString(this.queryParams),a=i.length?"?"+i.join("&"):"",s=""+(this.base||"")+r+a;this.useHash?(this.wasChangedByUser=!0,this.returnWindow().location.hash=s):this.returnWindow().history.pushState(null,null,s);var o=this.currentPathObject&&Object.keys(this.currentPathObject).length&&clone(this.currentPathObject);this.currentPathObject=n,this.currentPath=t,e||this.finishRouteChange(o,this.currentPathObject)}}},{key:"startRouteChange",value:function(t,e){this.events.startRouteChange.forEach(function(r){r(t,e)})}},{key:"finishRouteChange",value:function(t,e){this.events.finishRouteChange.forEach(function(r){r(t,e)}),this.previousQueryParam=clone(this.queryParams)}}]),t}();"undefined"!=typeof module&&"undefined"!=typeof module.exports?module.exports=EsRouter:window.EsRouter=EsRouter;