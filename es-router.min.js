"use strict";function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,r=Array(e.length);t<e.length;t++)r[t]=e[t];return r}return Array.from(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function isNotDefined(e){return"undefined"==typeof e||null===e}function clone(e){return JSON.parse(JSON.stringify(e))}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),EsRouter=function(){function e(t){var r=this,n=t.useHash,a=void 0===n?!1:n,i=t.routes,s=t.strictRouting,o=void 0===s?!1:s,u=t.home,h=t.base,c=t.routeOnLoad,l=void 0===c?!0:c;if(_classCallCheck(this,e),this.events={startRouteChange:[],finishRouteChange:[],paramChange:[]},this.useHash=a,this.routes=i,this.base=h,this.strictRouting=o,this.queryParams=this.getParamsFromUrl(),this.base=h&&"/"===h[h.length-1]&&"/"!==h?this.base.substring(0,this.base.length-1):h,!h&&!a){var f=document.getElementsByTagName("base")[0]&&document.getElementsByTagName("base")[0].href||"";this.base=f.split(window.location.origin)[1]}this.allRoutes=Object.assign(i,{}).reduce(function(e,t){if(t.name===u&&(r.home=t),t.variablePath)throw new Error("route objects cannot be initialized with a key of variablePath");var n=t.route.split("/").filter(function(e){return e}),a=n.length,i=n.reduce(function(e,t,r){var n={id:t.split(":")[1],index:r};return t.includes(":")?[].concat(_toConsumableArray(e),[n]):[].concat(_toConsumableArray(e))},[]);return t.variablePath=i,e[a]=e[a]?[].concat(_toConsumableArray(e[a]),[t]):[t],e},{}),a?(-1===window.location.href.indexOf("#")&&(window.location.hash="/"),window.addEventListener("hashchange",function(e){return r.wasChangedByUser?(r.wasChangedByUser=!1,void 0):(r.eventChangeListener.call(r,e),void 0)})):window.onpopstate=this.eventChangeListener.bind(this),l&&this.path(this.getPathFromUrl(),!1,!0)}return _createClass(e,[{key:"getState",value:function(){return this.currentPathObject}},{key:"getParamsFromUrl",value:function(){var e=this.useHash?window.location.hash.split("?")[1]:window.location.search.split("?")[1];return e&&e.split("&").reduce(function(e,t){var r=t.split("=");return e[decodeURIComponent(r[0])]=decodeURIComponent(r[1])||"",e},{})||{}}},{key:"getPathFromUrl",value:function(){var e=window.location.pathname,t=Math.max(0,e.indexOf(this.base)+this.base.length-1),r=e.slice(t)||"/";return this.useHash?window.location.hash.split("?")[0].substring(1):r}},{key:"eventChangeListener",value:function(){var e=this,t=this.getParamsFromUrl(),r=this.getPathFromUrl(),n=this.createParamString(t).join(""),a=this.createParamString(this.queryParams).join("");if(n!==a&&(this.queryParams=this.getParamsFromUrl(),this.events.paramChange.forEach(function(t){t(e.queryParams)})),r!==this.currentPath){this.currentPath=r;var i=this.getPreDefinedRoute(this.currentPath),s=clone(this.currentPathObject);this.currentPathObject=i,this.startRouteChange(s,i),this.finishRouteChange(s,i)}}},{key:"subscribe",value:function(e,t){var r=this;if(!e||!t)return{};if(!this.events.hasOwnProperty.call(this.events,e)||"string"!=typeof e||"function"!=typeof t)return{};var n=this.events[e].push(t)-1;return{remove:function(){delete r.events[e][n]}}}},{key:"unsubscribe",value:function(e){var t=this,r=function(t){return t!==e};Object.keys(this.events).forEach(function(e){t.events[e]=t.events[e].filter(r)})}},{key:"search",value:function(e,t){var r=this;if(isNotDefined(e))return this.queryParams;"object"===("undefined"==typeof e?"undefined":_typeof(e))?this.queryParams=Object.assign(this.queryParams,e):isNotDefined(t)?this.queryParams[e]&&delete this.queryParams[e]:this.queryParams[e]=t,Object.keys(this.queryParams).forEach(function(e){isNotDefined(r.queryParams[e])&&"number"!=typeof r.queryParams[e]&&delete r.queryParams[e]});var n=this.getParamsFromUrl(),a=this.createParamString(n).join(""),i=this.createParamString(this.queryParams).join("");return a===i?void 0:(this.path(this.currentPath,!0),this.events.paramChange.forEach(function(e){e(r.queryParams)}),this.queryParams)}},{key:"getPreDefinedRoute",value:function(e){var t=e.split("/").filter(function(e){return e}),r=clone(this.allRoutes);return r[t.length]&&r[t.length].reduce(function(e,r){if(e)return e;var n=[].concat(_toConsumableArray(t)),a=r.route.split("/").filter(function(e){return e}),i=void 0;if(r.variablePath&&r.variablePath.length&&(i=r.variablePath.reduce(function(e,t,r){var i=n.splice(t.index-r,1)[0];return a.splice(t.index-r,1),e[t.id]=i,e},{})),n.join("")===a.join("")){var s=Object.assign({},r);return s.variablePath=i,s}return!1},0)}},{key:"createParamString",value:function(e){return Object.keys(e).reduce(function(t,r){var n=r.toString(),a=e[r].toString();return isNotDefined(a)||Array.isArray(a)&&!a.length?t:[].concat(_toConsumableArray(t),[encodeURIComponent(n)+"="+encodeURIComponent(a)])},[])}},{key:"buildNewUrl",value:function(e){var t=this.createParamString(this.queryParams),r=t.length?"?"+t.join("&"):"",n=this.base.match(/^\//)?this.base:"/"+this.base,a=(""+n+e+r).replace(/\/{2,}/g,"/");return a}},{key:"path",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:!1;if(e){var n=e,a=this.getPreDefinedRoute(n),i=!1;!a&&this.strictRouting&&(n=this.home.route,a=this.home,i=!0),t||this.startRouteChange(this.currentPathObject,a);var s=this.buildNewUrl(n);(r===!1||i===!0)&&(this.useHash?(this.wasChangedByUser=!0,window.location.hash=s):window.history.pushState(null,null,s));var o=this.currentPathObject&&Object.keys(this.currentPathObject).length&&clone(this.currentPathObject);this.currentPathObject=a,this.currentPath=e,t||this.finishRouteChange(o,this.currentPathObject)}}},{key:"startRouteChange",value:function(e,t){this.events.startRouteChange.forEach(function(r){r(e,t)})}},{key:"finishRouteChange",value:function(e,t){this.events.finishRouteChange.forEach(function(r){r(e,t)}),this.previousQueryParam=clone(this.queryParams)}}]),e}();"undefined"!=typeof module&&"undefined"!=typeof module.exports?module.exports=EsRouter:window.EsRouter=EsRouter;